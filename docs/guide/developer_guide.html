<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Debugging and profiling - The Shadow Simulator</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="custom.css">
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="shadow.html">The Shadow Simulator</a></li><li class="chapter-item expanded "><a href="design_2x.html"><strong aria-hidden="true">1.</strong> Design Overview</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="security.html"><strong aria-hidden="true">1.1.</strong> Non-goal: Security</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> Installation Guide</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="supported_platforms.html"><strong aria-hidden="true">2.1.</strong> Supported Platforms</a></li><li class="chapter-item expanded "><a href="install_dependencies.html"><strong aria-hidden="true">2.2.</strong> Dependencies</a></li><li class="chapter-item expanded "><a href="install_shadow.html"><strong aria-hidden="true">2.3.</strong> Shadow</a></li><li class="chapter-item expanded "><a href="system_configuration.html"><strong aria-hidden="true">2.4.</strong> System Configuration</a></li><li class="chapter-item expanded "><a href="install_shadow_with_docker.html"><strong aria-hidden="true">2.5.</strong> (Experimental) Shadow with Docker</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> Usage Guide</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="run_shadow_overview.html"><strong aria-hidden="true">3.1.</strong> Overview</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.2.</strong> Running Your First Simulations</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="getting_started_basic.html"><strong aria-hidden="true">3.2.1.</strong> Basic File Transfer</a></li><li class="chapter-item expanded "><a href="getting_started_tgen.html"><strong aria-hidden="true">3.2.2.</strong> Traffic Generation</a></li><li class="chapter-item expanded "><a href="getting_started_tor.html"><strong aria-hidden="true">3.2.3.</strong> Simple Tor Network</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.3.</strong> Understanding Shadow Output</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="log_format.html"><strong aria-hidden="true">3.3.1.</strong> Format of the Log Messages</a></li><li class="chapter-item expanded "><a href="parsing_shadow_logs.html"><strong aria-hidden="true">3.3.2.</strong> Parsing Statistics from the Logs</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.4.</strong> Configuring Your Own Simulation</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="shadow_config_overview.html"><strong aria-hidden="true">3.4.1.</strong> Shadow Config Overview</a></li><li class="chapter-item expanded "><a href="shadow_config_spec.html"><strong aria-hidden="true">3.4.2.</strong> Shadow Config Specification</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.5.</strong> Configuring Your Own Network</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="network_graph_overview.html"><strong aria-hidden="true">3.5.1.</strong> Network Graph Overview</a></li><li class="chapter-item expanded "><a href="network_graph_spec.html"><strong aria-hidden="true">3.5.2.</strong> Network Graph Specification</a></li></ol></li><li class="chapter-item expanded "><a href="migrating_from_1x.html"><strong aria-hidden="true">3.6.</strong> Migrating Simulations from Shadow 1.x</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.7.</strong> Performance Tuning</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="sidechannels.html"><strong aria-hidden="true">3.7.1.</strong> Disabling Side-channel Mitigations</a></li></ol></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Developer Guides</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="developer_guide.html" class="active"><strong aria-hidden="true">4.1.</strong> Debugging and profiling</a></li><li class="chapter-item expanded "><a href="ci.html"><strong aria-hidden="true">4.2.</strong> Continous integration tests</a></li></ol></li><li class="chapter-item expanded "><a href="contributing.html"><strong aria-hidden="true">5.</strong> Contributing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="coding_style.html"><strong aria-hidden="true">5.1.</strong> Coding style</a></li><li class="chapter-item expanded "><a href="pull_requests.html"><strong aria-hidden="true">5.2.</strong> Pull requests</a></li></ol></li><li class="chapter-item expanded "><a href="maintainer_playbook.html"><strong aria-hidden="true">6.</strong> Maintainer playbook</a></li><li class="chapter-item expanded "><a href="nsf_sponsorship.html"><strong aria-hidden="true">7.</strong> NSF Sponsorship</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Shadow Simulator</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shadow/shadow" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="debugging-and-profiling"><a class="header" href="#debugging-and-profiling">Debugging and profiling</a></h1>
<h2 id="building-the-c-rust-bindings"><a class="header" href="#building-the-c-rust-bindings">Building the C-Rust bindings</a></h2>
<p>When required, you can rebuild all of the C-Rust bindings by running:</p>
<pre><code class="language-bash">cd build &amp;&amp; cmake --target bindings .. &amp;&amp; make bindings
</code></pre>
<p>To see the specific options/flags provided to bindgen and cbindgen, you can use
<code>make VERBOSE=1 bindings</code>.</p>
<p>Since the C bindings and Rust bindings rely on each other, you may sometimes
need to build the bindings in a specific order. Instead of <code>make bindings</code>, you
can be more specific using for example <code>make bindings_main_rust</code> to make the
Rust bindings for <code>src/main</code>.</p>
<p>You may need to install bindgen, cbindgen, and clang:</p>
<pre><code class="language-bash">apt install -y clang
cargo install --force --version 0.18.0 cbindgen
cargo install --force --version 0.57.0 bindgen
</code></pre>
<p>The versions of bindgen and cbindgen you install should match the <a href="https://github.com/shadow/shadow/blob/main/.github/workflows/lint.yml">versions
installed in the
CI</a>.</p>
<h2 id="extra-tests"><a class="header" href="#extra-tests">Extra tests</a></h2>
<p>Shadow includes tests that require additional dependencies, such as Tor, TGen,
and networkx. These aren't run by default, but are run as part of the CI tests.
To run them locally, first make sure that both tor and tgen are located at
<code>~/.local/bin/{tor,tgen}</code>. These can be symlinks to tor and tgen binaries
elsewhere in the filesystem. You should also install all of Shadow's optional
dependencies.</p>
<p>It is recommended to build Shadow in release mode, otherwise the Tor tests may
not complete before the timeout.</p>
<pre><code class="language-bash">./setup test -- --build-config extra
# To exclude the Tor tests (for example if you built Shadow in debug mode)
./setup test -- --build-config extra --label-exclude tor
</code></pre>
<p>If you change the version of tor located at <code>~/.local/bin/tor</code>, make sure to
re-run <code>./setup build --test</code>.</p>
<h2 id="debugging"><a class="header" href="#debugging">Debugging</a></h2>
<h3 id="debugging-shadow-using-gdb"><a class="header" href="#debugging-shadow-using-gdb">Debugging Shadow using GDB</a></h3>
<p>Shadow is currently built with debugging symbols in both debug and release
builds, though it may be easier to debug a debug build (generated by passing the
<code>--debug</code> flag to <code>setup build</code>).</p>
<p>Shadow can be run under <code>gdb</code> by prepending <code>gdb --args</code> to its command-line.
e.g.:</p>
<pre><code>gdb --args shadow shadow.config.xml
</code></pre>
<p>An alternative is to run shadow with the <code>-g</code> flag, which will pause shadow
after startup and print the <code>PID</code>. You can then simply attach gdb to shadow in a
new terminal and continue the experiment:</p>
<pre><code>shadow -g shadow.config.xml
# new terminal
gdb --pid=PID
&gt; continue
</code></pre>
<p>Note though, that GDB's <code>follow-fork-mode</code> setting should be left in its default
setting of <code>parent</code>; see below.</p>
<h3 id="debugging-virtual-processes"><a class="header" href="#debugging-virtual-processes">Debugging virtual processes</a></h3>
<p>As of Shadow 2.0, virtual processes in the simulation are implemented as native
OS processes, with their syscalls interposed by Shadow. Since they are native
processes, many normal tools for inspecting native processes can be used on
those as well. e.g. <code>top</code> will show how much CPU and memory they are using.</p>
<p>However, in its default mode of operation, Shadow uses ptrace to control these
processes. Since Linux only allows a process to be ptraced by one other process
at a time, gdb <em>cannot</em> attach to those processes.</p>
<p>If a virtual process is crashing (e.g. being killed by a signal within the
simulation), it is still possible to use gdb to help debug it by causing the
native process to generate a core file, and then using gdb to inspect it
afterwards:</p>
<pre><code># Enable core dumps
ulimit -c unlimited

# Run the simulation in which a process is crashing
shadow shadow.config.xml

# Tell gdb to inspect the core file. From within gdb you'll be able to
# inspect the state of the process just before it was killed. 
gdb &lt;path-to-process-executable&gt; &lt;path-to-core-file&gt;

# It's often useful to look at the stack backtrace:
&gt; bt

# Or for a multi-threaded process, to look at all of the threads' backtraces:
&gt; thread apply all bt
</code></pre>
<h3 id="tracing-shadow-using-valgrind"><a class="header" href="#tracing-shadow-using-valgrind">Tracing Shadow using Valgrind</a></h3>
<p>If you want to be able to run Shadow through valgrind and the application you
are running in Shadow uses OpenSSL (e.g. <code>tor</code>), you should configure OpenSSL
with the additional option: <code>-DPURIFY</code>. This fixes OpenSSL so it doesn't break
valgrind. You may also want to ensure that debugging symbols are included in the
GLib that Shadow links to, and any library used by the plug-in. This can be
achieved with the compiler flag <code>-g</code> when manually building a local version of
GLib.</p>
<h3 id="profiling-shadow"><a class="header" href="#profiling-shadow">Profiling Shadow</a></h3>
<h4 id="profiling-with-gprof"><a class="header" href="#profiling-with-gprof">Profiling with <code>gprof</code></a></h4>
<p>This method only provides profiling info for the core of Shadow, not for
plug-ins, or other libraries. Also, the profiling info is limited since gprof
only measures active CPU usage and function call counts and misses performance
related to blocking IO and barrier waits.</p>
<pre><code class="language-bash">./setup build -cgo
./setup install
cd resource/examples
shadow shadow.config.xml &gt; shadow.log
gprof `which shadow` gmon.out &gt; analysis.txt
less analysis.txt
</code></pre>
<h4 id="profiling-with-perf"><a class="header" href="#profiling-with-perf">Profiling with <code>perf</code></a></h4>
<p>Either run perf when starting Shadow:</p>
<pre><code class="language-bash">perf record shadow shadow.config.yaml &gt; shadow.log
</code></pre>
<p>Or, connect to a running Shadow process:</p>
<pre><code class="language-bash">perf record -p &lt;PID&gt;
</code></pre>
<p>Either of the above two options will write a <code>perf.data</code> file when you press
control-c, or Shadow ends. You can then analyze the report:</p>
<pre><code class="language-bash">perf report
</code></pre>
<p>Perf is extremely powerful with many options. See <code>man perf</code> or <a href="https://perf.wiki.kernel.org/index.php/Tutorial">the perf
wiki</a> for more info.</p>
<p>Note that any time an example uses the <code>-g</code> option in <code>perf record</code>, you should
use <code>--call-graph dwarf</code> instead. (The <code>-g</code> option defaults to stack frames for
traces, which elf-loader and certain optimizations can break. If you see
absurdly tall or small call graphs, this is probably what happened.)</p>
<h3 id="testing-for-deterministic-behavior"><a class="header" href="#testing-for-deterministic-behavior">Testing for Deterministic Behavior</a></h3>
<p>If you run Shadow twice with the same seed (the <code>-s</code> or <code>--seed</code> command line
options), then it <em>should</em> produce deterministic results (it's a bug if it
doesn't).</p>
<p>A good way to check this is to compare the log output of an application that was
run in Shadow. For example, after running two TGen experiments where the results
are in the <code>shadow.data.1</code> and <code>shadow.data.2</code> directories, you could run
something like the following bash script:</p>
<pre><code class="language-bash">#!/bin/bash

found_difference=0

for SUFFIX in \
    hosts/fileserver/stdout-fileserver.tgen.1000.log \
    hosts/client/stdout-client.tgen.1000.log
do
    ## ignore memory addresses in log file with `sed 's/0x[0-9a-f]*/HEX/g' FILENAME`
    sed -i 's/0x[0-9a-f]*/HEX/g' shadow.data.1/${SUFFIX}
    sed -i 's/0x[0-9a-f]*/HEX/g' shadow.data.2/${SUFFIX}

    diff --brief shadow.data.1/${SUFFIX} shadow.data.2/${SUFFIX}
    exit_code=$?

    if (($exit_code != 0)); then
      found_difference=1
    fi
done

if (($found_difference == 1)); then
  echo -e &quot;\033[0;31mDetected difference in output (Shadow may be non-deterministic).\033[0m&quot;
else
  echo -e &quot;\033[0;32mDid not detect difference in Shadow output (Shadow may be deterministic).\033[0m&quot;
fi
</code></pre>
<p>If you find non-deterministic behavior in your Shadow experiment, please
consider helping to diagnose the problem by opening a <a href="https://github.com/shadow/shadow/issues/new">new
issue</a>.</p>
<h3 id="building-the-guide"><a class="header" href="#building-the-guide">Building the Guide</a></h3>
<pre><code class="language-bash">cargo install mdbook
(cd mdbook &amp;&amp; mdbook build)
firefox build/guide/index.html
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="sidechannels.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="ci.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="sidechannels.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="ci.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
