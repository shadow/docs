<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Coding - The Shadow Simulator</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="custom.css">

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="shadow.html">The Shadow Simulator</a></li><li class="chapter-item expanded "><a href="design_2x.html"><strong aria-hidden="true">1.</strong> Design Overview</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> Installation Guide</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="supported_platforms.html"><strong aria-hidden="true">2.1.</strong> Supported Platforms</a></li><li class="chapter-item expanded "><a href="install_dependencies.html"><strong aria-hidden="true">2.2.</strong> Dependencies</a></li><li class="chapter-item expanded "><a href="install_shadow.html"><strong aria-hidden="true">2.3.</strong> Shadow</a></li><li class="chapter-item expanded "><a href="system_configuration.html"><strong aria-hidden="true">2.4.</strong> System Configuration</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> Usage Guide</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="run_shadow_overview.html"><strong aria-hidden="true">3.1.</strong> Running Your First Simulations</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="getting_started_basic.html"><strong aria-hidden="true">3.1.1.</strong> Basic File Transfer</a></li><li class="chapter-item expanded "><a href="getting_started_tgen.html"><strong aria-hidden="true">3.1.2.</strong> Traffic Generation</a></li><li class="chapter-item expanded "><a href="getting_started_tor.html"><strong aria-hidden="true">3.1.3.</strong> Simple Tor Network</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.2.</strong> Simulation Configuration</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="shadow_config_overview.html"><strong aria-hidden="true">3.2.1.</strong> Shadow Config Overview</a></li><li class="chapter-item expanded "><a href="shadow_config_spec.html"><strong aria-hidden="true">3.2.2.</strong> Shadow Config Specification</a></li><li class="chapter-item expanded "><a href="shadow_config_complex.html"><strong aria-hidden="true">3.2.3.</strong> Managing Complex Configurations</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.3.</strong> Network Configuration</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="network_graph_overview.html"><strong aria-hidden="true">3.3.1.</strong> Network Graph Overview</a></li><li class="chapter-item expanded "><a href="network_graph_spec.html"><strong aria-hidden="true">3.3.2.</strong> Network Graph Specification</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.4.</strong> Performance Tuning</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="sidechannels.html"><strong aria-hidden="true">3.4.1.</strong> Disabling Side-channel Mitigations</a></li><li class="chapter-item expanded "><a href="parallel_sims.html"><strong aria-hidden="true">3.4.2.</strong> Parallel Simulations</a></li><li class="chapter-item expanded "><a href="profiling.html"><strong aria-hidden="true">3.4.3.</strong> Profiling</a></li></ol></li><li class="chapter-item expanded "><a href="semver.html"><strong aria-hidden="true">3.5.</strong> Stability Guarantees</a></li><li class="chapter-item expanded "><a href="security.html"><strong aria-hidden="true">3.6.</strong> Non-goal: Security</a></li><li class="chapter-item expanded "><a href="limitations.html"><strong aria-hidden="true">3.7.</strong> Known limitations and workarounds</a></li><li class="chapter-item expanded "><a href="compatibility_notes.html"><strong aria-hidden="true">3.8.</strong> Compatibility Notes</a></li></ol></li><li class="chapter-item expanded "><a href="contributing.html"><strong aria-hidden="true">4.</strong> Contributing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="coding_style.html"><strong aria-hidden="true">4.1.</strong> Coding style</a></li><li class="chapter-item expanded "><a href="writing_tests.html"><strong aria-hidden="true">4.2.</strong> Writing tests</a></li><li class="chapter-item expanded "><a href="pull_requests.html"><strong aria-hidden="true">4.3.</strong> Pull requests</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Developer Guide</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="coding.html" class="active"><strong aria-hidden="true">5.1.</strong> Coding</a></li><li class="chapter-item expanded "><a href="debugging.html"><strong aria-hidden="true">5.2.</strong> Debugging</a></li><li class="chapter-item expanded "><a href="profiling.html"><strong aria-hidden="true">5.3.</strong> Profiling</a></li><li class="chapter-item expanded "><a href="testing_determinism.html"><strong aria-hidden="true">5.4.</strong> Testing for Nondeterminism</a></li><li class="chapter-item expanded "><a href="extra_tests.html"><strong aria-hidden="true">5.5.</strong> Extra Tests</a></li><li class="chapter-item expanded "><a href="ci.html"><strong aria-hidden="true">5.6.</strong> Continuous integration tests</a></li><li class="chapter-item expanded "><a href="maintainer_playbook.html"><strong aria-hidden="true">5.7.</strong> Maintainer playbook</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.8.</strong> Shadow Output</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="log_format.html"><strong aria-hidden="true">5.8.1.</strong> Format of the Log Messages</a></li><li class="chapter-item expanded "><a href="parsing_shadow_logs.html"><strong aria-hidden="true">5.8.2.</strong> Parsing Statistics from the Logs</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="nsf_sponsorship.html"><strong aria-hidden="true">6.</strong> NSF Sponsorship</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Shadow Simulator</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/shadow/shadow" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="coding"><a class="header" href="#coding">Coding</a></h1>
<h2 id="building-the-guide"><a class="header" href="#building-the-guide">Building the guide</a></h2>
<pre><code class="language-bash">cargo install mdbook
(cd mdbook &amp;&amp; mdbook build)
firefox build/guide/index.html
</code></pre>
<h2 id="generating-compiler-command-database"><a class="header" href="#generating-compiler-command-database">Generating compiler command database</a></h2>
<p>Many tools benefit from a <a href="https://clangd.llvm.org/design/compile-commands">compiler command
database</a>, conventionally in a
file called <code>compile_commands.json</code>. If shadow's <code>setup</code> script finds the
<a href="https://github.com/rizsotto/Bear">bear</a> tool on your <code>PATH</code>, it will
automatically use it to create and update <code>build/compile_commands.json</code> when
running <code>setup build</code>.</p>
<h2 id="files-and-descriptors"><a class="header" href="#files-and-descriptors">Files and descriptors</a></h2>
<img class="color-adapting-image" style="width: 100%;" src="assets/files-and-descriptors.svg">
<p>Shadow currently has two ways of simulating descriptors. The first is
<a href="https://github.com/shadow/shadow/blob/ff671ffdf038597334ae467c56fe774c40b7864a/src/main/host/descriptor/descriptor_types.h#L48-L60"><code>LegacyDescriptor</code></a> which is written in C and is used for
most descriptor/file types (IP sockets, epoll, files, etc). With this type, the
epoll file / posix description and its descriptor live in the same object. The
second way of simulating descriptors is in Rust, where we have a <a href="https://shadow.github.io/docs/rust/shadow_rs/host/descriptor/enum.File.html"><code>File</code></a>
type that can be referenced by many <a href="https://shadow.github.io/docs/rust/shadow_rs/host/descriptor/struct.Descriptor.html"><code>Descriptor</code></a> objects.  This
allows us to easily implement <a href="https://shadow.github.io/docs/rust/shadow_rs/host/descriptor/struct.Descriptor.html#method.dup"><code>dup()</code></a> for descriptors implemented with
this new code. Our plan is to move existing legacy descriptors over to these
new Rust file types.</p>
<h2 id="platform-libc-and-linux-crates"><a class="header" href="#platform-libc-and-linux-crates">Platform (libc and Linux) crates</a></h2>
<p>We use several Rust crates for accessing platform functionality and definitions.
Roughly from lowest-level to highest-level:</p>
<ul>
<li>
<p>Our <a href="https://github.com/shadow/shadow/tree/main/src/lib/linux-api"><code>linux-api</code></a>
crate provides fairly low-level bindings over the Linux kernel headers, and a
few <code>nix</code>-style higher-level wrappers. It does not depend on <code>std</code> or <code>libc</code>.
It also re-exports these definitions as a C library that can be used without
creating conflicts with libc headers or linux system headers.
Use this when working with the syscall ABI (such as when implementing syscall
handlers), and for making syscalls when none of the higher-level crates are
suitable (see below).</p>
</li>
<li>
<p><a href="https://docs.rs/libc/latest/libc/"><code>libc</code></a> provides fairly low-level bindings
of system libc standard headers. If you need syscall-level ABI-compatibility,
use <code>linux-api</code> instead. If you don't, prefer one of the higher-level crates.</p>
</li>
<li>
<p><a href="https://docs.rs/nix/latest/nix/"><code>nix</code></a> provides a safer and more Rust-idiomatic
layer on top of the <code>libc</code> crate, as well as adapters for underlying <code>libc</code> definitions.
There's currently a lot of usage of this in Shadow, but we're trying to move away from it.
In most scenarios, one of the other crates mentioned here is a more appropriate choice.</p>
</li>
<li>
<p><a href="https://docs.rs/rustix/latest/rustix/"><code>rustix</code></a> provides a similar API to <code>nix</code>, but
can be configured not to depend on <code>std</code> or <code>libc</code>. This is useful in code that's linked
into Shadow's shim, where we don't want to depend on <code>std</code> or <code>libc</code>.</p>
</li>
<li>
<p>Rust's <a href="https://doc.rust-lang.org/std/"><code>std</code></a> crate provides, well, the standard
way of interacting with the platform, in a portable and Rust-idiomatic way. This is
generally the right choice for code that <em>doesn't</em> run in Shadow's shim, in places
we're not concerned about the precise syscalls that get executed.</p>
</li>
</ul>
<p>When choosing which one to use:</p>
<ul>
<li>
<p>For code that will be linked into shadow's
<a href="https://github.com/shadow/shadow/tree/main/src/lib/shim">shim</a>, prefer
<code>rustix</code>. In cases where <code>rustix</code> doesn't provide the desired
functionality, or in C code, or when we need precise control over what
syscall is made with what parameters, use <code>linux-api</code>.</p>
<p>We want to minimize, and ideally eliminate, usage of <code>libc</code> from the shim. <code>libc</code> has
global state that can easily become corrupted when we use it from the shim,
which is <code>LD_PRELOAD</code>ed into managed programs. This is especially because
much of the shim executes in the context of <code>SIGSYS</code> signal handlers, meaning we might already
be in a non-reentrant, non-<a href="https://man7.org/linux/man-pages/man7/signal-safety.7.html">async-signal-safe</a> libc function higher in the stack. See also <a href="https://github.com/shadow/shadow/milestone/54">https://github.com/shadow/shadow/milestone/54</a>. </p>
</li>
<li>
<p>For shadow's syscall handler implementations, prefer <code>linux-api</code>.</p>
<p>Since we are intercepting and implementing at the syscall level, the interface
we are implementing is the Linux syscall ABI interface. Therefore we should
be careful to use Linux's definitions for the parameters and return values.
While types and constants in libc are <em>often</em> equivalent to kernel types and
constants with the same names, there are many known cases where they
aren't, and in general there's no guarantee even that one that is consistent
today will remain consistent tomorrow. See also
<a href="https://github.com/shadow/shadow/issues/3007">https://github.com/shadow/shadow/issues/3007</a>.</p>
<p>This also applies when implementing a syscall by delegating to the host
system.  For example suppose we implement a <code>fcntl</code> syscall by by making a
native <code>fcntl</code> syscall on the native file descriptor. Making the syscall
directly is the most straightforward way to &quot;pass through&quot; exactly the
original intended semantics. If we use a higher level interface, even
<code>libc</code>, we have to be careful about translating the parameters and return
values back and forth between the two different API layers.</p>
</li>
<li>
<p>For code that runs in the shadow process, where we are acting as a &quot;normal&quot; program
that wants to interact with the kernel, generally prefer the highest-level
interface that provides the necessary functionality. e.g. when creating worker
threads in Rust, we generally use <code>std::thread</code>; there's no reason to use one of the lower
level crates. Occasionally we need some functionality not provided in <code>std</code> though, in which case it makes sense to drop down to one of the lower level crates.</p>
</li>
<li>
<p>In tests, any of the above can make sense. In places we're specifically trying
to test shadow's emulation of some functionality, making direct syscalls,
e.g. with the <code>linux-api</code> crate or <code>libc</code>'s <code>syscall</code> function, is the most
direct and precise approach. On the other hand, we often want to test higher
level interfaces as a form of integration testing, since those are more
typically what managed programs use.  We usually focus on testing at the
<code>libc</code> interface, since most managed programs use that interface, and it's
low-level enough to be able to control and understand what's happening at
the syscall level. For incidental system functionality in tests (e.g.
creating a temp file, in a test that isn't specifically trying to test that
functionality) it usually makes sense to use whatever interface is most
idiomatic and convenient.</p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="pull_requests.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="debugging.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="pull_requests.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="debugging.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
